using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Serialization;
using pentest_challenge.Contracts;
using pentest_challenge.Models;

namespace pentest_challenge.Controllers
{
    public class ApiController : Controller
    {
        private readonly ITokenStorage _storage;
        private readonly ITokenValidator _validator;

        public ApiController(ITokenStorage storage, ITokenValidator validator)
        {
            _storage = storage;
            _validator = validator;
        }

        public JsonSerializerSettings JsonSettings = new JsonSerializerSettings
        {
            ContractResolver = new CamelCasePropertyNamesContractResolver()
        };

        [HttpGet("api/validate-token")]
        public JsonResult ValidateToken()
        {
            var token = Request.Cookies[TokenInformation.CookieTokenKey]; 
            if (token == null)
                return new JsonResult(BadRequest("Login token cookie is mandatory in 'Cookie' header"), JsonSettings);

            return Json(_validator.Validate(token), JsonSettings);
        }
    }
}